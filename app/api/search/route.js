import { NextResponse } from "next/server";

export async function POST(request) {

    try {
        const filters = await request.json();

        let hasParkingFilter = ``;
        let petFriendlyFilter = ``;
        let minPriceFilter = ``;
        let maxPriceFilter = ``;

        if(filters.hasParking) {
            hasParkingFilter = `
                {
                    key: "has_parking"
                    compare: EQUAL_TO
                    value: "1"
                },
            `
        }

        if(filters.petFriendly) {
            petFriendlyFilter = `
                {
                    key: "pet_friendly"
                    compare: EQUAL_TO
                    value: "1"
                },
            `
        }

        if(filters.minPrice) {
            minPriceFilter = `
                {
                    key: "price"
                    compare: GREATER_THAN_OR_EQUAL_TO
                    value: "${filters.minPrice}"
                    type: NUMERIC
                },
            `
        }

        if(filters.maxPrice) {
            maxPriceFilter = `
                {
                    key: "price"
                    compare: LESS_THAN_OR_EQUAL_TO
                    value: "${filters.maxPrice}"
                    type: NUMERIC
                },
            `
        }

        const response = await fetch(process.env.WP_GRAPHQL_URL, {
            method: "POST",
            headers: {
                'Content-Type': "application/json"
            },
            body: JSON.stringify({
                query: `
                query AllPropertiesQuery {
                    properties(
                        where: {
                            offsetPagination: {
                                size: 3, 
                                offset: ${((filters.page || 1) - 1) * 3}
                            }
                            metaQuery: {
                                relation: AND
                                metaArray: [
                                    ${petFriendlyFilter}
                                    ${hasParkingFilter}
                                    ${minPriceFilter}
                                    ${maxPriceFilter}
                                ]}
                        }) {
                        pageInfo {
                            offsetPagination {
                                total
                            }
                        }
                        nodes {
                            databaseId
                            title
                            uri
                            featuredImage {
                                node {
                                uri
                                sourceUrl
                                }
                            }
                            propertyFeatures {
                                bathrooms
                                bedrooms
                                hasParking
                                petFriendly
                                price
                            }      
                        }
                    }
                }
            `
            })
        });      

        const {data} = await response.json();

        console.log("SERVER SIDE: ", data.properties.nodes);

        return NextResponse.json({
            total: data.properties.pageInfo.offsetPagination.total,
            properties: data.properties.nodes,
        });

    } catch(e) {
        console.log("ERROR: ", e);
    }
}

